name: Build and Deploy (Vite) into GitHub Pages docs subfolder (services/web-frontend-vite)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write # docs 폴더에 커밋/푸시 필요

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (cache by ROOT lock)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json # 루트 lock

      - name: Install (root)
        run: npm ci

      - name: Build workspace (services/web-frontend-vite)
        run: npm run build -w ./services/web-frontend-vite

      - name: Prepare docs/web-frontend-vite
        run: |
          mkdir -p docs/web-frontend-vite
          # 기존 산출물만 정리 (다른 docs 콘텐츠는 건드리지 않음)
          rm -rf docs/web-frontend-vite/*
          cp -r services/web-frontend-vite/dist/* docs/web-frontend-vite/
          # SPA 라우팅(fallback). HashRouter면 생략 가능
          cp docs/web-frontend-vite/index.html docs/web-frontend-vite/404.html || true

      - name: Commit & push changes to docs/
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/web-frontend-vite
          git diff --cached --quiet && echo "No changes to commit" || git commit -m "chore: publish Vite build to docs/web-frontend-vite"
          git push
